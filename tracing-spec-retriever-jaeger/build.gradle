apply plugin: 'java-library'

dependencies {
    api project(':tracing-spec-model')
    api 'io.jaegertracing:jaeger-proto'

    integrationImplementation 'org.testcontainers:testcontainers'
    integrationImplementation 'io.jaegertracing:jaeger-thrift'
}

/* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * */

dockerImages.getAllTags('jaegertracing/all-in-one').forEach { String tagName ->
    if (!tagName.matches(/\d+\.\d+/)) return

    SourceSet testSourceSet = sourceSets.integration
    TaskProvider<Task> testVersionTask = tasks.register("testIntegration-$tagName", Test) {
        dependsOn(testSourceSet.classesTaskName)

        systemProperty('docker-image-tag', tagName)

        Test testTask = tasks.test
        group = testTask.group
        testClassesDirs = testTask.testClassesDirs
        classpath = testTask.classpath

        filter {
            includeTestsMatching('*VersionTest')
            failOnNoMatchingTests = true
        }
    }

    tasks.named('check').configure { dependsOn(testVersionTask) }
}
